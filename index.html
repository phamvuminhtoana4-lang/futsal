<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Futsal Ultimate Tactical</title>
    <style>
        :root { --field: #1b5e20; --line: rgba(255,255,255,0.8); }
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; touch-action: none; }
        #game-wrapper { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        
        .screen { position: relative; flex: 1; background: var(--field); border-bottom: 4px solid #333; overflow: hidden; }
        #screen-p2 { transform: rotate(180deg); } /* Màn hình người chơi 2 xoay ngược */
        
        canvas { display: block; width: 100%; height: 100%; }
        
        .hud { position: absolute; width: 100%; padding: 15px; box-sizing: border-box; color: white; z-index: 10; 
               display: flex; justify-content: space-between; font-weight: bold; pointer-events: none; text-shadow: 2px 2px 4px #000; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
                   z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        button { padding: 18px 40px; margin: 12px; font-size: 18px; border-radius: 50px; border: none; 
                 background: linear-gradient(135deg, #ff9800, #f57c00); color: white; font-weight: bold; cursor: pointer; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="screen-p2" class="screen">
        <div class="hud"><div>TRẮNG: <span class="s-white">0</span> - ĐỎ: <span class="s-red">0</span></div></div>
        <canvas id="cv-p2"></canvas>
    </div>
    <div id="screen-p1" class="screen">
        <div class="hud">
            <div>ĐỎ: <span class="score-red s-red">0</span> - TRẮNG: <span class="score-white s-white">0</span></div>
            <div id="clock">40:00</div>
        </div>
        <canvas id="cv-p1"></canvas>
    </div>
</div>

<div id="ui-start" class="overlay">
    <h1 style="font-size: 3rem; color: #ff9800; margin-bottom: 0;">FUTSAL ULTIMATE</h1>
    <p style="letter-spacing: 2px;">TACTICAL ENGINE v2.0</p>
    <button onclick="boot(2.0)">CHẾ ĐỘ VỚI MÁY (KHÓ)</button>
    <button onclick="boot(0)" style="background: #1e88e5;">PVP: HAI NGƯỜI CHƠI</button>
</div>

<script>
/**
 * ENGINE CORE
 */
const cv1 = document.getElementById('cv-p1'), cv2 = document.getElementById('cv-p2');
const ctx1 = cv1.getContext('2d'), ctx2 = cv2.getContext('2d');

let W, H, mode = 0, state = 'menu';
let score = { r: 0, w: 0 }, timer = 40 * 60;
let ball = { x: 0, y: 0, vx: 0, vy: 0, r: 7, owner: null, lastOwner: null };
let players = [];
let dragMap = new Map();

class Player {
    constructor(x, y, team, pos) {
        this.x = x; this.y = y; this.team = team; this.pos = pos;
        this.r = 15; this.tx = x; this.ty = y;
        this.originX = x; this.originY = y;
        this.color = team === 'red' ? (pos==='GK'?'#00b0ff':'#ff1744') : (pos==='GK'?'#424242':'#fff');
    }

    update() {
        // Vật lý di chuyển có quán tính
        let dx = this.tx - this.x, dy = this.ty - this.y;
        let dist = Math.hypot(dx, dy);
        if (dist > 1) {
            let speed = (ball.owner === this) ? 3.2 : 4.0; // Dẫn bóng chạy chậm hơn tí
            this.x += (dx / dist) * speed;
            this.y += (dy / dist) * speed;
        }
        if (ball.owner === this) {
            ball.x = this.x; ball.y = this.y;
            ball.vx = ball.vy = 0;
        }
    }
}

function boot(lvl) {
    mode = lvl; state = 'play';
    document.getElementById('ui-start').style.display = 'none';
    setup();
    requestAnimationFrame(engine);
}

function setup() {
    W = cv1.clientWidth; H = cv1.clientHeight; 
    cv1.width = cv2.width = W; cv1.height = cv2.height = H;

    // Đội hình 1-2-1 Diamond chuẩn Futsal
    players = [
        // Đỏ (Dưới)
        new Player(W/2, H-30, 'red', 'GK'),
        new Player(W/2, H-120, 'red', 'FIXO'),
        new Player(W/4, H-220, 'red', 'ALA'),
        new Player(3*W/4, H-220, 'red', 'ALA'),
        new Player(W/2, H-350, 'red', 'PIVO'),
        // Trắng (Trên)
        new Player(W/2, 30, 'white', 'GK'),
        new Player(W/2, 120, 'white', 'FIXO'),
        new Player(W/4, 220, 'white', 'ALA'),
        new Player(3*W/4, 220, 'white', 'ALA'),
        new Player(W/2, 350, 'white', 'PIVO')
    ];
    resetBall();
}

function resetBall() {
    ball.x = W/2; ball.y = H/2; ball.vx = ball.vy = 0; ball.owner = null;
}

// Hệ thống Input Đa điểm Độc lập
window.addEventListener('touchstart', e => handle(e, 's'), {passive:false});
window.addEventListener('touchmove', e => handle(e, 'm'), {passive:false});
window.addEventListener('touchend', e => handle(e, 'e'), {passive:false});

function handle(e, type) {
    if (state !== 'play') return;
    e.preventDefault();
    const r1 = cv1.getBoundingClientRect();

    Array.from(e.changedTouches).forEach(t => {
        let x, y, team;
        if (t.clientY > r1.top) { // Vùng P1
            x = t.clientX; y = t.clientY - r1.top; team = 'red';
        } else { // Vùng P2 (Mirror)
            x = W - t.clientX; y = H - t.clientY; team = 'white';
        }

        if (type === 's' || type === 'm') {
            players.forEach(p => {
                if (p.team === team && Math.hypot(x - p.x, y - p.y) < 55) { p.tx = x; p.ty = y; }
            });
            if (type === 's') dragMap.set(t.identifier, { x, y });
        }

        if (type === 'e' && ball.owner && ball.owner.team === team) {
            let s = dragMap.get(t.identifier);
            if (s) {
                let dx = x - s.x, dy = y - s.y;
                if (Math.hypot(dx, dy) > 25) {
                    ball.vx = dx * 0.16; ball.vy = dy * 0.16;
                    ball.lastOwner = ball.owner;
                    ball.owner = null;
                }
            }
            dragMap.delete(t.identifier);
        }
    });
}

function aiBrain() {
    if (mode === 0) return;
    players.filter(p => p.team === 'white').forEach(p => {
        let distToBall = Math.hypot(ball.x - p.x, ball.y - p.y);
        
        if (p.pos === 'GK') { // Thủ môn AI biết ra vào
            p.tx = (ball.x - W/2) * 0.2 + W/2;
            p.ty = (ball.y < H/3) ? ball.y * 0.5 : 30;
        } else {
            // Chiến thuật kèm người: Nếu bóng ở xa, về vị trí gốc. Nếu bóng gần, áp sát.
            let targetX = (distToBall < 180) ? ball.x : p.originX;
            let targetY = (distToBall < 180) ? ball.y : p.originY;
            p.tx += (targetX - p.tx) * 0.04 * mode;
            p.ty += (targetY - p.ty) * 0.04 * mode;
        }
    });
}

function engine() {
    if (state !== 'play') return;
    timer--;

    players.forEach(p => p.update());

    if (!ball.owner) {
        ball.x += ball.vx; ball.y += ball.vy;
        ball.vx *= 0.975; ball.vy *= 0.975; // Ma sát cỏ
        
        // Va chạm cầu thủ (Cướp bóng)
        players.forEach(p => {
            if (Math.hypot(ball.x - p.x, ball.y - p.y) < p.r + ball.r) {
                ball.owner = p;
            }
        });
    }

    // Luật bàn thắng & Biên
    if (ball.x < 8 || ball.x > W-8) ball.vx *= -0.6;
    if (ball.y < 5 && ball.x > W/3 && ball.x < 2*W/3) { score.w++; resetBall(); } // Trắng ghi bàn
    else if (ball.y < 0) ball.vy *= -0.6;
    
    if (ball.y > H-5 && ball.x > W/3 && ball.x < 2*W/3) { score.r++; resetBall(); } // Đỏ ghi bàn
    else if (ball.y > H) ball.vy *= -0.6;

    aiBrain();
    render();
    requestAnimationFrame(engine);
}

function render() {
    [ctx1, ctx2].forEach((ctx, i) => {
        ctx.clearRect(0, 0, W, H);
        // Sân bóng
        ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 2;
        ctx.strokeRect(10, 10, W-20, H-20);
        ctx.beginPath(); ctx.moveTo(0, H/2); ctx.lineTo(W, H/2); ctx.stroke();
        ctx.beginPath(); ctx.arc(W/2, H/2, 50, 0, Math.PI*2); ctx.stroke();
        // Gôn
        ctx.fillStyle = "#fff"; ctx.fillRect(W/3, 2, W/3, 8); ctx.fillRect(W/3, H-10, W/3, 8);

        players.forEach(p => p.draw(ctx));
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fillStyle = "yellow"; ctx.shadowBlur = 10; ctx.shadowColor = "yellow"; ctx.fill();
        ctx.shadowBlur = 0; ctx.stroke();
    });

    document.querySelectorAll('.s-red').forEach(e => e.innerText = score.r);
    document.querySelectorAll('.s-white').forEach(e => e.innerText = score.w);
    document.getElementById('clock').innerText = Math.floor(timer/600) + ":00";
}
</script>
</body>
</html>
