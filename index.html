<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Futsal Strategy AI - 2 Player</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; }
        #game-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        canvas { border: 2px solid #fff; box-sizing: border-box; touch-action: none; }
        #p1-canvas { border-bottom: 2px solid yellow; } /* Màn hình trên */
        #p2-canvas { border-top: 2px solid yellow; }    /* Màn hình dưới */
        
        #ui-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: rgba(0,0,0,0.8); color: white; padding: 20px; text-align: center; 
                    border-radius: 10px; z-index: 10; pointer-events: auto; }
        .btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; margin: 5px; cursor: pointer; }
        #scoreboard { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                      background: rgba(0,0,0,0.5); color: white; padding: 5px; border-radius: 5px; pointer-events: none; }
    </style>
</head>
<body>

<div id="scoreboard">
    Time: <span id="game-time">00:00</span> | Score: <span id="score">0 - 0</span>
</div>

<div id="ui-layer">
    <h2>FUTSAL STRATEGY</h2>
    <div id="menu">
        <button class="btn" onclick="startGame('pve', 1)">Đấu AI (Thường)</button>
        <button class="btn" onclick="startGame('pve', 2)">Đấu AI (Khá)</button>
        <button class="btn" onclick="startGame('pve', 3)">Đấu AI (Pro)</button><br>
        <button class="btn" onclick="startGame('pvp')">Đấu với Bạn (2 Người)</button>
    </div>
</div>

<div id="game-container">
    <canvas id="p1-canvas"></canvas>
    <canvas id="p2-canvas"></canvas>
</div>

<script>
/** * Cấu hình hệ thống Game 
 */
const canvas1 = document.getElementById('p1-canvas');
const canvas2 = document.getElementById('p2-canvas');
const ctx1 = canvas1.getContext('2d');
const ctx2 = canvas2.getContext('2d');

let gameMode = 'pve'; // pve hoặc pvp
let aiLevel = 1;
let isRunning = false;
let gameTime = 0; // Giây thực tế, quy đổi ra 90p trong game
let score = { team1: 0, team2: 0 };
let penaltyMode = false;

// Kích thước sân
const pitch = { w: 400, h: 600, goalW: 80 };
function resize() {
    const w = window.innerWidth;
    const h = window.innerHeight / 2;
    canvas1.width = canvas2.width = w;
    canvas1.height = canvas2.height = h;
}
window.addEventListener('resize', resize);
resize();

// Đối tượng cầu thủ và bóng
class Player {
    constructor(x, y, team, isGK) {
        this.originX = x; this.originY = y;
        this.x = x; this.y = y;
        this.team = team;
        this.isGK = isGK;
        this.radius = 12;
        this.selected = false;
        this.color = team === 1 ? (isGK ? '#0000FF' : '#FF0000') : (isGK ? '#000000' : '#FFFFFF');
    }
    draw(ctx) {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.strokeStyle = this.selected ? 'yellow' : '#333';
        ctx.lineWidth = 3;
        ctx.stroke();
    }
}

let ball = { x: 200, y: 300, vx: 0, vy: 0, radius: 7 };
let team1 = [], team2 = [];

function initPlayers() {
    team1 = [
        new Player(200, 550, 1, true), // GK
        new Player(100, 450, 1, false), new Player(300, 450, 1, false),
        new Player(150, 350, 1, false), new Player(250, 350, 1, false)
    ];
    team2 = [
        new Player(200, 50, 2, true), // GK
        new Player(100, 150, 2, false), new Player(300, 150, 2, false),
        new Player(150, 250, 2, false), new Player(250, 250, 2, false)
    ];
    ball.x = 200; ball.y = 300; ball.vx = 0; ball.vy = 0;
}

/** * Logic Điều khiển (Kéo thả, Chuyền, Sút)
 */
function handleInput(canvas, players, isBottomView) {
    let lastTap = 0;
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Xử lý Sút (Double Click)
        let now = Date.now();
        if (now - lastTap < 300) {
            shootBall(mouseX, mouseY);
            return;
        }
        lastTap = now;

        // Chọn cầu thủ để kéo
        players.forEach(p => {
            const dist = Math.hypot(p.x - mouseX, p.y - mouseY);
            if (dist < p.radius * 2) p.selected = true;
        });

        // Chuyền bóng
        if (!players.some(p => p.selected)) {
            passBall(mouseX, mouseY);
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        players.forEach(p => {
            if (p.selected) {
                p.x = e.clientX - rect.left;
                p.y = e.clientY - rect.top;
            }
        });
    });

    canvas.addEventListener('mouseup', () => {
        players.forEach(p => p.selected = false);
    });
}

function passBall(tx, ty) {
    const angle = Math.atan2(ty - ball.y, tx - ball.x);
    ball.vx = Math.cos(angle) * 5;
    ball.vy = Math.sin(angle) * 5;
}

function shootBall(tx, ty) {
    const angle = Math.atan2(ty - ball.y, tx - ball.x);
    ball.vx = Math.cos(angle) * 12;
    ball.vy = Math.sin(angle) * 12;
}

/**
 * AI Logic
 */
function updateAI() {
    if (gameMode !== 'pve') return;
    team2.forEach(p => {
        // Cấp độ 1: Chỉ đứng nhìn
        // Cấp độ 2: Di chuyển theo bóng
        if (aiLevel >= 2) {
            p.x += (ball.x - p.x) * (0.01 * aiLevel);
            p.y += (ball.y - p.y) * (0.01 * aiLevel);
        }
        // Cấp độ 3: Sút khi gần bóng
        if (aiLevel === 3 && Math.hypot(p.x - ball.x, p.y - ball.y) < 30) {
            shootBall(200, 600);
        }
    });
}

/**
 * Vòng lặp Game
 */
function update() {
    if (!isRunning) return;

    // Di chuyển bóng
    ball.x += ball.vx;
    ball.y += ball.vy;
    ball.vx *= 0.98; ball.vy *= 0.98; // Ma sát

    // Va chạm biên
    if (ball.x < 0 || ball.x > canvas1.width) ball.vx *= -1;
    
    // Ghi bàn
    if (ball.y < 10 && Math.abs(ball.x - 200) < 40) { score.team1++; resetBall(); }
    if (ball.y > 590 && Math.abs(ball.x - 200) < 40) { score.team2++; resetBall(); }

    // Cập nhật AI
    updateAI();

    // Cập nhật UI
    gameTime += 1/60;
    const minutes = Math.floor(gameTime * 5); // Tỉ lệ 1s real = 5 phút game
    document.getElementById('game-time').innerText = `${minutes}:00`;
    document.getElementById('score').innerText = `${score.team1} - ${score.team2}`;

    if (minutes >= 90) {
        if (score.team1 === score.team2) startPenalty();
        else endGame();
    }

    draw();
    requestAnimationFrame(update);
}

function resetBall() {
    ball.x = 200; ball.y = 300; ball.vx = 0; ball.vy = 0;
}

function draw() {
    [ctx1, ctx2].forEach((ctx, i) => {
        ctx.clearRect(0, 0, canvas1.width, canvas1.height);
        // Vẽ sân
        ctx.fillStyle = "#2e7d32";
        ctx.fillRect(0, 0, canvas1.width, canvas1.height);
        // Vạch sân
        ctx.strokeStyle = "white";
        ctx.strokeRect(10, 10, 380, 580);
        ctx.strokeRect(160, 0, 80, 20); // Gôn 1
        ctx.strokeRect(160, 580, 80, 20); // Gôn 2

        // Vẽ cầu thủ & bóng
        team1.forEach(p => p.draw(ctx));
        team2.forEach(p => p.draw(ctx));
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();
        ctx.stroke();
    });
}

/**
 * Penalty Mode
 */
function startPenalty() {
    isRunning = false;
    alert("Hòa! Bắt đầu đá luân lưu 5 quả.");
    // Thực hiện logic ẩn vị trí sút/chặn như yêu cầu trong 10s
    // Đây là khung sườn, bạn có thể mở rộng UI chọn hướng
}

function startGame(mode, level) {
    gameMode = mode;
    aiLevel = level || 1;
    document.getElementById('ui-layer').style.display = 'none';
    initPlayers();
    isRunning = true;
    handleInput(canvas1, team1, false);
    handleInput(canvas2, (gameMode === 'pvp' ? team2 : []), true);
    update();
}

function endGame() {
    isRunning = false;
    alert(`Kết thúc! Tỷ số: ${score.team1} - ${score.team2}`);
    location.reload();
}
</script>
</body>
</html>
